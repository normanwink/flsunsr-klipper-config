[gcode_macro UNLOAD_FILAMENT]
description: Unload filament
variable_tube_length: 600.0   # Given value should be longer than the actual bowden tube
gcode:
  {% set DESIRED_TEMP = params.TEMP|default(215, true)|float %}
  {% set TUBE_LENGTH = printer["gcode_macro UNLOAD_FILAMENT"].tube_length|float %}
  SAVE_GCODE_STATE NAME=unload_state

  {% if printer.extruder.temperature < DESIRED_TEMP %}
    RESPOND TYPE=command MSG='Heating...'
    M109 S{DESIRED_TEMP}      # Heat up hotend to provided temp or 215 as default as that should work OK with most filaments
  {% endif %}

  RESPOND TYPE=command MSG='Unloading filament...'
  G91                         # Relative positioning
  G0 E10 F400                 # Mini-Purge
  G0 E-20 F2500               # Quick Retract
  G0 E-{TUBE_LENGTH} F2000    # Unload the rest of the filament
  M400                        # Finish moves

  RESPOND TYPE=command MSG='Filament unloaded!'
  RESTORE_GCODE_STATE NAME=unload_state